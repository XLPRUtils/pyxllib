name: Release to PyPI using Trusted Publisher
on:
  push:
    tags:
      - 'v*'  # 只要推送以 v 开头的 tag 就触发

jobs:
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest

    environment:
      name: release

    permissions:
      contents: write # [新增] 必须加上这个权限，Action 才能创建 GitHub Release
      id-token: write # [保留] 用于 PyPI Trusted Publisher 认证

    steps:
      - uses: actions/checkout@v4
      
      - uses: astral-sh/setup-uv@v5
        with:
          version: "0.9.22"
      
      - run: uv build
      
      - run: uv publish --trusted-publishing always

      # 智能处理标题，防止版本号重复
      - name: Prepare Release Info
        id: release_info
        run: |
          TAG=${{ github.ref_name }}
          # 获取提交信息
          MSG=$(git log -1 --pretty=%s)
          
          # 判断：如果 MSG 已经包含了 TAG（比如以 TAG 开头），就直接用 MSG
          # 否则，拼接 TAG + 空格 + MSG
          if [[ "$MSG" == *"$TAG"* ]]; then
            echo "final_title=$MSG" >> $GITHUB_OUTPUT
          else
            echo "final_title=$TAG $MSG" >> $GITHUB_OUTPUT
          fi
          
          # 把原始消息也输出出来，放在正文里用
          echo "body_msg=$MSG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # [修改] 使用上面计算好的“智能标题”
          name: ${{ steps.release_info.outputs.final_title }}
          
          # [修改] 正文部分保持原样
          body: |
            ${{ steps.release_info.outputs.body_msg }}
            
            ---
          files: dist/*
          generate_release_notes: true