name: Release to PyPI using Trusted Publisher
on:
  push:
    tags:
      - 'v*'  # 只要推送以 v 开头的 tag 就触发

jobs:
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest

    environment:
      name: release

    permissions:
      contents: write # [新增] 必须加上这个权限，Action 才能创建 GitHub Release
      id-token: write # [保留] 用于 PyPI Trusted Publisher 认证

    steps:
      - uses: actions/checkout@v4
      
      - uses: astral-sh/setup-uv@v5
        with:
          version: "0.9.22"
      
      - run: uv build
      
      - run: uv publish --trusted-publishing always

      # 提取当前 tag 对应的提交信息
      - name: Get Commit Message
        id: commit_msg
        run: |
          # 获取最近一次提交的说明（首行）
          MSG=$(git log -1 --pretty=%s)
          echo "msg=$MSG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # [修改] 自定义标题格式：Tag名 + 提交信息 (例如: v4.33 修复了BUG)
          name: ${{ github.ref_name }} ${{ steps.commit_msg.outputs.msg }}
          # [修改] 将提交信息也放入正文，同时保留自动生成的变更日志
          body: |
            ${{ steps.commit_msg.outputs.msg }}
            
            ---
          files: dist/*
          generate_release_notes: true